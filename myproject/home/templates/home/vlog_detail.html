{% extends 'home/base.html' %}

{% block title %}{{ vlog.title }} - Safar{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Video Player -->
            <div class="card shadow-lg border-0 rounded-4 overflow-hidden mb-4">
                <div class="ratio ratio-16x9 bg-dark">
                    {% if vlog.video_file %}
                    <video controls class="w-100 h-100" poster="{{ vlog.thumbnail }}">
                        <source src="{{ vlog.video_file.url }}" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                    {% elif vlog.video_url %}
                    <iframe src="{{ vlog.get_embed_url }}" title="{{ vlog.title }}" allowfullscreen></iframe>
                    {% else %}
                    <div class="d-flex align-items-center justify-content-center text-white h-100">
                        <div class="text-center">
                            <i class="bi bi-camera-video-off display-1 mb-3"></i>
                            <p class="h5">Video not available</p>
                        </div>
                    </div>
                    {% endif %}
                </div>
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <h1 class="h2 fw-bold mb-2">{{ vlog.title }}</h1>
                            <div class="d-flex align-items-center text-muted gap-3">
                                <span><i class="bi bi-person-fill me-1"></i>{{
                                    vlog.author.get_full_name|default:vlog.author.username }}</span>
                                <span><i class="bi bi-calendar-event me-1"></i>{{ vlog.upload_date|date:"M d, Y"
                                    }}</span>
                                <span><i class="bi bi-eye-fill me-1"></i>{{ vlog.views }} views</span>
                            </div>
                        </div>
                        <div class="d-flex gap-2">
                            {% if user.is_authenticated %}
                            <button class="btn btn-outline-danger rounded-pill px-3" onclick="likeVlog({{ vlog.id }})">
                                <i class="bi bi-heart me-1"></i> <span id="like-count">{{ vlog.likes }}</span>
                            </button>
                            {% endif %}

                            {% if user == vlog.author or user.is_staff %}
                            <a href="{% url 'home:edit_vlog' vlog.id %}"
                                class="btn btn-outline-primary rounded-pill px-3">
                                <i class="bi bi-pencil-fill me-1"></i> Edit
                            </a>
                            {% endif %}
                        </div>
                    </div>

                    <hr class="my-4">

                    <h5 class="fw-bold mb-3">Description</h5>
                    <p class="lead text-secondary">{{ vlog.description|linebreaks }}</p>

                    {% if vlog.tags %}
                    <div class="mt-4">
                        {% for tag in vlog.tags %}
                        <span class="badge bg-light text-dark border me-1 rounded-pill px-3 py-2">#{{ tag }}</span>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Related Vlogs -->
            {% if related_vlogs %}
            <h3 class="fw-bold mb-4">More from {{ vlog.destination.name }}</h3>
            <div class="row g-4">
                {% for related in related_vlogs %}
                <div class="col-md-6 col-lg-4">
                    <div class="card h-100 shadow-sm border-0 rounded-4 overflow-hidden hover-card">
                        <div class="position-relative">
                            <img src="{{ related.thumbnail }}" class="card-img-top" alt="{{ related.title }}"
                                style="height: 200px; object-fit: cover;">
                            <span
                                class="position-absolute bottom-0 end-0 bg-dark bg-opacity-75 text-white px-2 py-1 m-2 rounded small">
                                {{ related.duration|default:"00:00" }}
                            </span>
                        </div>
                        <div class="card-body">
                            <h5 class="card-title fw-bold h6 text-truncate">{{ related.title }}</h5>
                            <p class="card-text text-muted small mb-2"><i class="bi bi-geo-alt-fill me-1"></i>{{
                                related.destination.name }}</p>
                            <a href="{% url 'home:vlog_detail' related.id %}" class="stretched-link"></a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}

        </div>
    </div>
</div>

<script>
    function likeVlog(vlogId) {
        fetch(`/api/vlogs/${vlogId}/like/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('like-count').innerText = data.likes;
                }
            });
    }
</script>
{% endblock %}